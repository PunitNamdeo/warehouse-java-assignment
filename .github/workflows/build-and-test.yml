name: Build & Test with Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  JAVA_VERSION: '21'
  MAVEN_VERSION: '3.9.12'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Display Java version
      run: java -version
    
    - name: Build with Maven (compile, test, and generate Quarkus JaCoCo report)
      working-directory: ./java-assignment
      run: mvn -B clean verify
    
    - name: Verify JaCoCo report files exist
      working-directory: ./java-assignment
      if: always()
      run: |
        test -f target/jacoco-report/jacoco.csv
        test -f target/jacoco-report/jacoco.xml
        test -f target/jacoco-report/index.html
    
    - name: Display Test Results Summary
      working-directory: ./java-assignment
      if: always()
      run: |
        echo "=== Test Execution Summary ==="
        if [ -f target/surefire-reports/index.html ]; then
          find target/surefire-reports -name "*.txt" -exec cat {} \;
        fi
    
    - name: Display Code Coverage Report
      working-directory: ./java-assignment
      if: always()
      run: |
        echo "=== Code Coverage Summary ==="
        if [ -f target/jacoco-report/index.html ]; then
          echo "Coverage report generated at target/jacoco-report/index.html"
          python -c "import csv; r=list(csv.DictReader(open('target/jacoco-report/jacoco.csv'))); s=lambda k:sum(int(x[k]) for x in r); im,ic,lm,lc,bm,bc=[s(k) for k in ['INSTRUCTION_MISSED','INSTRUCTION_COVERED','LINE_MISSED','LINE_COVERED','BRANCH_MISSED','BRANCH_COVERED']]; print(f'Instruction: {ic*100/(ic+im):.2f}%'); print(f'Line: {lc*100/(lc+lm):.2f}%'); print(f'Branch: {bc*100/(bc+bm):.2f}%')"
        fi
    
    - name: Upload Test Results as Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: java-assignment/target/surefire-reports/
        retention-days: 30
    
    - name: Upload Code Coverage Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-coverage-report
        path: java-assignment/target/jacoco-report/
        retention-days: 30
    
    - name: Upload JAR Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: java-assignment/target/*.jar
        retention-days: 30
    
    - name: Publish Test Report Summary
      if: always()
      run: |
        echo "# Build & Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Status" >> $GITHUB_STEP_SUMMARY
        echo "- Java Version: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test Results: uploaded to test-results" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage Report: uploaded to jacoco-coverage-report" >> $GITHUB_STEP_SUMMARY
        echo "- Application JAR: uploaded to application-jar" >> $GITHUB_STEP_SUMMARY

  sonarqube-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build for SonarQube Analysis
      working-directory: ./java-assignment
      run: mvn -B clean verify
    
    - name: Run SonarQube Scanner
      if: env.SONAR_TOKEN != ''
      uses: SonarSource/sonarqube-scan-action@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=warehouse-assignment
          -Dsonar.organization=punitnamdeo
          -Dsonar.sources=java-assignment/src/main
          -Dsonar.tests=java-assignment/src/test
          -Dsonar.coverage.jacoco.xmlReportPaths=java-assignment/target/jacoco-report/jacoco.xml
      continue-on-error: true

    - name: Skip SonarQube Scanner (missing SONAR_TOKEN)
      if: env.SONAR_TOKEN == ''
      run: echo "Skipping SonarQube scan because SONAR_TOKEN is not configured."

  health-check:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success()
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: mydatabase
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: admin123
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U admin -d mydatabase"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Package Application (skip tests)
      working-directory: ./java-assignment
      run: mvn -B -DskipTests package

    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U admin -d mydatabase; then
            echo "PostgreSQL is ready"
            exit 0
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        echo "PostgreSQL did not become ready in time"
        exit 1
    
    - name: Start Application in Background
      working-directory: ./java-assignment
      run: |
        nohup java -jar target/quarkus-app/quarkus-run.jar > app.log 2>&1 &
        echo $! > app.pid
      timeout-minutes: 2
    
    - name: Health Check
      run: |
        # Wait for Quarkus health endpoint to be ready
        for i in {1..90}; do
          if curl -f http://localhost:8080/q/health > /dev/null 2>&1; then
            echo "Application is healthy on /q/health"
            curl -I http://localhost:8080/q/health
            exit 0
          fi
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "Application is healthy on /health"
            curl -I http://localhost:8080/health
            exit 0
          fi
          echo "Waiting for application... ($i/90)"
          sleep 2
        done
        echo "Application health check failed"
        if [ -f java-assignment/app.log ]; then
          echo "=== Last 200 lines of app.log ==="
          tail -n 200 java-assignment/app.log
        fi
        exit 1
    
    - name: Check Endpoints Availability
      run: |
        # Note: These may fail if application startup takes longer
        # This is a best-effort check
        for endpoint in "/store" "/warehouse" "/fulfillment/warehouse-product-store" "/q/health"; do
          echo "Checking $endpoint endpoint..."
          curl -f http://localhost:8080$endpoint 2>/dev/null || echo "Endpoint $endpoint not responding yet"
        done
      continue-on-error: true

    - name: Stop Application
      if: always()
      working-directory: ./java-assignment
      run: |
        if [ -f app.pid ]; then
          kill "$(cat app.pid)" || true
        fi
      continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'java-assignment'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy Results
      if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  notify-results:
    runs-on: ubuntu-latest
    needs: [ build-and-test, sonarqube-analysis, health-check, security-scan ]
    if: always()
    
    steps:
    - name: Print Build Status
      run: |
        echo "Build & Test Status: ${{ job.status }}"
        echo "Build & Test Outcome: ${{ needs.build-and-test.result }}"
        echo "Health Check Outcome: ${{ needs.health-check.result }}"
        echo "Security Scan Outcome: ${{ needs.security-scan.result }}"
    
    - name: Create Success Badge Data
      if: needs.build-and-test.result == 'success'
      run: |
        echo "BADGE_COLOR=green" >> $GITHUB_ENV
        echo "BADGE_MESSAGE=passing" >> $GITHUB_ENV
    
    - name: Create Failure Badge Data
      if: needs.build-and-test.result != 'success'
      run: |
        echo "BADGE_COLOR=red" >> $GITHUB_ENV
        echo "BADGE_MESSAGE=failing" >> $GITHUB_ENV
    
    - name: Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Build Badge Color: ${{ env.BADGE_COLOR }}"
        echo "Build Badge Message: ${{ env.BADGE_MESSAGE }}"
