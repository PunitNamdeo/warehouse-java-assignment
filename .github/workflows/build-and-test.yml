name: Build & Test with Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_VERSION: '3.9.12'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Display Java version
      run: java -version
    
    - name: Build with Maven (compile and run tests)
      working-directory: ./java-assignment
      run: mvn clean install -DskipTests=false
    
    - name: Generate JaCoCo Code Coverage Report
      working-directory: ./java-assignment
      run: mvn jacoco:report
      continue-on-error: true
    
    - name: Verify Code Coverage is 80% or above
      working-directory: ./java-assignment
      run: mvn jacoco:check
      continue-on-error: false
    
    - name: Display Test Results Summary
      working-directory: ./java-assignment
      if: always()
      run: |
        echo "=== Test Execution Summary ==="
        if [ -f target/surefire-reports/index.html ]; then
          find target/surefire-reports -name "*.txt" -exec cat {} \;
        fi
    
    - name: Display Code Coverage Report
      working-directory: ./java-assignment
      if: always()
      run: |
        echo "=== Code Coverage Summary ==="
        if [ -f target/site/jacoco/index.html ]; then
          echo "Coverage report generated at target/site/jacoco/index.html"
        fi
    
    - name: Upload Test Results as Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: java-assignment/target/surefire-reports/
        retention-days: 30
    
    - name: Upload Code Coverage Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: jacoco-coverage-report
        path: java-assignment/target/site/jacoco/
        retention-days: 30
    
    - name: Upload JAR Artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: application-jar
        path: java-assignment/target/*.jar
        retention-days: 30
    
    - name: Check if Build Successful
      if: failure()
      run: |
        echo "Build failed. Please check the logs and test results above."
        exit 1
    
    - name: Publish Test Report Summary
      if: always()
      run: |
        echo "# Build & Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Status" >> $GITHUB_STEP_SUMMARY
        echo "- Java Version: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test Results: uploaded to test-results" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage Report: uploaded to jacoco-coverage-report" >> $GITHUB_STEP_SUMMARY
        echo "- Application JAR: uploaded to application-jar" >> $GITHUB_STEP_SUMMARY

  sonarqube-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build for SonarQube Analysis
      working-directory: ./java-assignment
      run: mvn clean install
    
    - name: Run SonarQube Scanner
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=warehouse-assignment
          -Dsonar.sources=java-assignment/src/main
          -Dsonar.tests=java-assignment/src/test
          -Dsonar.coverage.jacoco.xmlReportPaths=java-assignment/target/site/jacoco/jacoco.xml
      continue-on-error: true

  health-check:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
    
    - name: Start Application in Background
      working-directory: ./java-assignment
      run: |
        mvn quarkus:dev &
        sleep 30
      timeout-minutes: 2
      continue-on-error: true
    
    - name: Health Check
      run: |
        # Wait for port 8080 to be listening
        for i in {1..30}; do
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "Application is healthy!"
            curl -I http://localhost:8080/health
            exit 0
          fi
          echo "Waiting for application... ($i/30)"
          sleep 1
        done
        echo "Application health check failed"
        exit 1
      continue-on-error: true
    
    - name: Check Endpoints Availability
      run: |
        # Note: These may fail if application startup takes longer
        # This is a best-effort check
        for endpoint in "/store" "/warehouse" "/fulfillment/warehouse-product-store" "/health"; do
          echo "Checking /health endpoint..."
          curl -f http://localhost:8080/health 2>/dev/null || echo "Endpoint $endpoint not responding yet"
        done
      continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'java-assignment'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()
      continue-on-error: true

  notify-results:
    runs-on: ubuntu-latest
    needs: [ build-and-test, sonarqube-analysis, health-check, security-scan ]
    if: always()
    
    steps:
    - name: Print Build Status
      run: |
        echo "Build & Test Status: ${{ job.status }}"
        echo "Build & Test Outcome: ${{ needs.build-and-test.result }}"
        echo "Health Check Outcome: ${{ needs.health-check.result }}"
        echo "Security Scan Outcome: ${{ needs.security-scan.result }}"
    
    - name: Create Success Badge Data
      if: needs.build-and-test.result == 'success'
      run: |
        echo "BADGE_COLOR=green" >> $GITHUB_ENV
        echo "BADGE_MESSAGE=passing" >> $GITHUB_ENV
    
    - name: Create Failure Badge Data
      if: needs.build-and-test.result != 'success'
      run: |
        echo "BADGE_COLOR=red" >> $GITHUB_ENV
        echo "BADGE_MESSAGE=failing" >> $GITHUB_ENV
    
    - name: Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Build Badge Color: ${{ env.BADGE_COLOR }}"
        echo "Build Badge Message: ${{ env.BADGE_MESSAGE }}"
